define(["exports","lodash","jquery","websockets/binary_websockets","jquery-growl","common/util"],function(a,b,c,d){"use strict";function e(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.digits_after_decimal=a.unregister=a.subscribe=a.register=a.keyFor=void 0;var f=e(b),g=e(c),h=e(d),i=a.keyFor=function(a,b){var c=b||0;return"string"==typeof c&&(c=convertToTimeperiodObject(c).timeInSeconds()),(a+c).toUpperCase()},j=a.register=function(a){var b=this,c=b.keyFor(a.symbol,a.granularity),d=a.granularity||0,e=0!=d&&a.style?a.style:"ticks",f=!0;"string"==typeof d&&("0"===g["default"].trim(d)||("1t"===g["default"].trim(d).toLowerCase()?d=convertToTimeperiodObject(d).timeInSeconds():(f=!1,d=convertToTimeperiodObject(d).timeInSeconds())));var i={ticks_history:a.symbol,granularity:d,count:a.count||1,end:"latest",style:e};if(1===a.subscribe&&(i.subscribe=1),!f){var j=a.count||1,k=(new Date).getTime()/1e3-j*d|0,l=new Date;l.setUTCFullYear(l.getUTCFullYear()-3),l.setDate(l.getDate()+1),1e3*k<l.getTime()&&(k=l.getTime()/1e3|0),i.style="candles",i.start=k,i.adjust_start_time=a.adjust_start_time||1}return b[c]={symbol:a.symbol,granularity:d,subscribers:0,chartIDs:[]},i.subscribe&&(b[c].subscribers=1),h["default"].send(i,3e4)["catch"](function(d){if(i.subscribe&&"MarketIsClosed"===d.code)return g["default"].growl.notice({message:a.symbol+" market is presently closed.".i18n()}),delete i.subscribe,b[c].subscribers-=1,h["default"].send(i,3e4);throw delete b[c],d})},k=a.subscribe=function(a,b){var c=this;c[a]&&(c[a].subscribers+=1,b&&c[a].chartIDs.push(b))},l=a.unregister=function(a,b){var c=this;if(c[a]){b&&f["default"].remove(c[a].chartIDs,{containerIDWithHash:b}),c[a].subscribers-=1,0===c[a].chartIDs.length&&c[a].timerHandler&&(clearInterval(c[a].timerHandler),c[a].timerHandler=null);var d=c[a].symbol,e=c[c.keyFor(d,0)]&&c[c.keyFor(d,0)].subscribers;0===c[a].subscribers&&c[a].id&&h["default"].send({forget:c[a].id}).then(function(){e&&c.register({symbol:d,granularity:0,subscribe:1,count:50})})["catch"](function(a){}),0===c[a].subscribers&&delete c[a]}},m=a.digits_after_decimal=function(a){return a=a&&a+"",a.substring(a.indexOf(".")+1).length};a["default"]={keyFor:i,register:j,subscribe:k,unregister:l,digits_after_decimal:m}});