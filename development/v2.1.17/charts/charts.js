define(["exports","jquery","charts/chartingRequestMap","websockets/binary_websockets","websockets/ohlc_handler","currentPriceIndicator","charts/indicators/highcharts_custom/indicators","moment","lodash","text!charts/indicators/indicators.json","common/highchartsMousewheel","instruments/instruments","highcharts-exporting","common/util","paralleljs","jquery-growl"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.changeTitle=a.overlay=a.addIndicator=a.refresh=a.triggerReflow=a.drawChart=a.generate_csv=a.destroy=void 0;var n=m(b),o=m(c),p=m(d),q=m(e),r=m(f),s=m(g),t=m(h),u=m(i),v=m(j),w=m(k),x=m(l),y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},z=local_storage.get("i18n")?local_storage.get("i18n").value.replace("_","-"):"en";"en"!==z&&require(["moment-locale/"+z]);var A=u["default"](JSON.parse(v["default"])).values().value();Highcharts.Chart.prototype.get_indicators=function(){var a=this,b=[];return a.series.length>0&&A.forEach(function(c){var d=c.id;a.series[0][d]&&a.series[0][d].forEach(function(a){b.push({id:d,name:c.long_display_name,options:a.options})})}),b},Highcharts.Chart.prototype.set_indicators=function(a){var b=this;b.series&&b.series[0]&&a.forEach(function(a){a.options.onSeriesID&&(a.options.onSeriesID=b.series[0].options.id),b.series[0].addIndicator(a.id,a.options)})},Highcharts.Chart.prototype.get_indicator_series=function(){var a=this,b=[];return a.series.length>0&&A.forEach(function(c){var d=c.id;a.series[0][d]&&a.series[0][d][0]&&b.push({id:d,series:a.series[0][d]})}),b},Highcharts.Chart.prototype.set_indicator_series=function(a){var b=this;b.series&&0!=b.series.length&&a.forEach(function(a){b.series[0][a.id]=a.series})},Highcharts.Chart.prototype.get_overlay_count=function(){var a=0;return this.series.forEach(function(b,c){b.options.isInstrument&&-1==b.options.id.indexOf("navigator")&&0!=c&&a++}),a},n["default"](function(){Highcharts.setOptions({global:{useUTC:!0,canvasToolsURL:"https://code.highcharts.com/modules/canvas-tools.js"},lang:{thousandsSep:","}});var a=Highcharts.getOptions().lang;Object.keys(a).forEach(function(b){return"object"===y(a[b])?void a[b].forEach(function(c,d){a[b][d]=c.i18n()}):void(a[b]=a[b].i18n())})}),s["default"].initHighchartIndicators(o["default"].barsTable);var B=a.destroy=function(a){var b=a.containerIDWithHash,c=a.timePeriod,d=a.instrumentCode;if(c&&d){var e=o["default"].keyFor(d,c);o["default"].unregister(e,b)}},C=a.generate_csv=function(a,b){var c=b.instrumentName+" ("+b.timePeriod+").csv",d=[],e=[],f=function(a){var b=null;if(u["default"].isArray(a)&&a.length>3){var c=a[0];b='"'+t["default"].utc(c).format("YYYY-MM-DD HH:mm")+'",'+a.slice(1,a.length).join(",")}else b=u["default"].isNumber(a.high)?'"'+t["default"].utc(a.time).format("YYYY-MM-DD HH:mm")+'",'+a.open+","+a.high+","+a.low+","+a.close:u["default"].isArray(a)&&a.length>1?'"'+t["default"].utc(a[0]).format("YYYY-MM-DD HH:mm")+'",'+a[1]:u["default"].isObject(a)&&a.title&&a.text?a instanceof FractalUpdateObject?'"'+t["default"].utc(a.x||a.time).format("YYYY-MM-DD HH:mm")+'",'+(a.isBull?"UP":a.isBear?"DOWN":" "):'"'+t["default"].utc(a.x||a.time).format("YYYY-MM-DD HH:mm")+'",'+a.text:u["default"].isNumber(a.y)?'"'+t["default"].utc(a.x||a.time).format("YYYY-MM-DD HH:mm")+'",'+(a.y||a.close):a.toString();return b};a.series.forEach(function(a,c){if("navigator"===a.options.id)return!0;var g=a.options.data.map(function(a){return f(a)})||[];if(0==c){var h=g[0].split(",").length>2;d.push(h?"Date,Time,Open,High,Low,Close":'Date,Time,"'+a.options.name+'"');var i=o["default"].keyFor(b.instrumentCode,b.timePeriod),j=o["default"].barsTable.chain().find({instrumentCdAndTp:i}).simplesort("time",!1).data();d=d.concat(j.map(function(a){return h?['"'+t["default"].utc(a.time).format("YYYY-MM-DD HH:mm")+'"',a.open,a.high,a.low,a.close].join(","):['"'+t["default"].utc(a.time).format("YYYY-MM-DD HH:mm:ss")+'"',a.close].join(",")}))}else d[0]+=',"'+a.options.name+'"',e.push(g)}),n["default"].growl.notice({message:"Downloading .csv".i18n()}),new Parallel([d,e]).spawn(function(a){var b=a[0],c=a[1];return b=b.map(function(a,b){return c.forEach(function(b){var c=!1;b.forEach(function(b){if(b){var d=b.split(",");if(a.split(",")[0]===d[0])return a+=","+d.slice(1,d.length).join(","),c=!0,!1}}),-1!=a.indexOf("Date")||c||(a+=",")}),0===b?a:a.split(" ").join('","')})}).then(function(a){var b=a.join("\n"),d=new Blob([b],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(d,c);else{var e=document.createElement("a");if(void 0!==e.download){var f=URL.createObjectURL(d);e.setAttribute("href",f),e.setAttribute("download",c),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}},function(a){n["default"].growl.error({message:"Error downloading .csv".i18n()})})},D=a.drawChart=function(a,b,c){var d=[],e=[],f=[];if(p["default"].cached.send({active_symbols:"brief"}).then(function(a){f=u["default"].filter(a.active_symbols,{symbol:b.instrumentCode})[0]}),n["default"](a).highcharts()){var g=o["default"].keyFor(b.instrumentCode,b.timePeriod);o["default"].removeChart(g,a);var h=n["default"](a).highcharts();d=h.get_indicators()||[],e=b.overlays||[],h.destroy()}b.indicators&&(d=b.indicators||[],e=b.overlays||[],n["default"](a).data("overlayCount",e.length)),("candlestick"===b.type||"ohlc"===b.type)&&e.length>0&&(e=[]),n["default"](a).data({instrumentCode:b.instrumentCode,instrumentName:b.instrumentName,timePeriod:b.timePeriod,type:b.type,delayAmount:b.delayAmount}),n["default"](a).highcharts("StockChart",{chart:{events:{load:function(){this.showLoading(),r["default"].init(),p["default"].execute(function(){q["default"].retrieveChartDataAndRender({timePeriod:b.timePeriod,instrumentCode:b.instrumentCode,containerIDWithHash:a,type:b.type,instrumentName:b.instrumentName,series_compare:b.series_compare,delayAmount:b.delayAmount})["catch"](function(c){var d="Error getting data for %1".i18n().replace("%1",b.instrumentName);n["default"].growl.error({message:d});var e=n["default"](a).highcharts();e&&e.showLoading(d)}).then(function(){var b=n["default"](a).highcharts();setTimeout(function(){b&&b.set_indicators(d),e.forEach(function(b){H(a,b.symbol,b.displaySymbol,b.delay_amount)})},0)})}),n["default"].isFunction(c)&&c(),this.margin[2]=5,this.spacing[2]=0}},spacingLeft:0,marginLeft:55,marginBottom:15,spacingBottom:15},navigator:{enabled:!0,series:{id:"navigator"}},plotOptions:{candlestick:{shadow:!1},series:{events:{afterAnimate:function(){this.options.isInstrument&&"navigator"!==this.options.id&&(this.removeCurrentPrice(),this.addCurrentPrice(),w["default"].mousewheel(a)),this.chart.hideLoading()}}}},title:{text:""},credits:{href:"#",text:""},xAxis:{events:{afterSetExtremes:function(){}},labels:{formatter:function(){var a=this.axis.defaultLabelFormatter.call(this);return a.replace(".","")}},ordinal:!1},scrollbar:{liveRedraw:!1},yAxis:[{opposite:!1,labels:{reserveSpace:!0,formatter:function(){if(f&&f.pip){var b=(f.pip+"").split(".")[1].length;return n["default"](a).data("overlayIndicator")?(this.value>0?" + ":"")+this.value+"%":this.value.toFixed(b)}},align:"center"}}],rangeSelector:{enabled:!1},tooltip:{crosshairs:[{width:2,color:"red",dashStyle:"dash"},{width:2,color:"red",dashStyle:"dash"}],formatter:function(){t["default"].locale(z);var a="<i>"+t["default"].utc(this.x).format("dddd, DD MMM YYYY, HH:mm:ss")+"</i><br>";return n["default"].each(this.points,function(){a+='<span style="color:'+this.point.color+'">‚óè </span>',"undefined"!=typeof this.point.open?(a+="<b>"+this.series.name+"</b>",a+="<br>"+"  Open".i18n()+": "+this.point.open,a+="<br>"+"  High".i18n()+": "+this.point.high,a+="<br>"+"  Low".i18n()+": "+this.point.low,a+="<br>"+"  Close".i18n()+": "+this.point.close):a+=this.series.name+": <b>"+this.point.y+"</b>",a+="<br>"}),a},enabled:!0,enabledIndicators:!0},exporting:{enabled:!1,url:"https://export.highcharts.com",filename:b.instrumentName.split(" ").join("_")+"("+b.timePeriod+")"}})},E=a.triggerReflow=function(a){n["default"](a).highcharts()&&n["default"](a).highcharts().reflow()},F=a.refresh=function(a,b,c,d,e){var f=n["default"](a).data("instrumentCode");if(b){var g=o["default"].keyFor(f,n["default"](a).data("timePeriod"));o["default"].unregister(g,a),n["default"](a).data("timePeriod",b)}c?n["default"](a).data("type",c):c=n["default"](a).data("type",c);var h=n["default"](a).highcharts(),i=this,j=[],k=void 0;"ohlc"!==c&&"candlestick"!==c&&n["default"](h.series).each(function(a,b){b.options.isInstrument&&(j.push(b.name),k=b.options.compare)}),e||(e=[],j.forEach(function(b){var c=x["default"].getSpecificMarketData(b);if(void 0!=c.symbol&&n["default"].trim(c.symbol)!=n["default"](a).data("instrumentCode")){var d={symbol:c.symbol,displaySymbol:b,delay_amount:c.delay_amount};e.push(d)}})),i.drawChart(a,{instrumentCode:f,instrumentName:n["default"](a).data("instrumentName"),timePeriod:n["default"](a).data("timePeriod"),type:n["default"](a).data("type"),series_compare:k,delayAmount:n["default"](a).data("delayAmount"),overlays:e,indicators:d})},G=a.addIndicator=function(a,b){if(n["default"](a).highcharts()){var c=n["default"](a).highcharts(),d=c.series[0];d&&c.addIndicator(n["default"].extend({id:d.options.id},b))}},H=a.overlay=function(a,b,c,d){if(n["default"](a).highcharts()){var e=n["default"](a).highcharts(),f=e.get_indicator_series(),g=n["default"](a).data("timePeriod"),h=n["default"](a).data("type");e.showLoading();for(var i=0;i<e.series.length;i++){var j=e.series[i];(j.options.isInstrument||j.options.onChartIndicator)&&j.update({compare:"percent"})}return new Promise(function(i){p["default"].execute(function(){q["default"].retrieveChartDataAndRender({timePeriod:g,instrumentCode:b,containerIDWithHash:a,type:h,instrumentName:c,series_compare:"percent",delayAmount:d}).then(function(){e&&e.set_indicator_series(f),0===e.series[0].data.length,i()})["catch"](i)})})}return Promise.resolve()},I=a.changeTitle=function(a,b){var c=n["default"](a).highcharts();c.setTitle(b)};a["default"]={drawChart:D,destroy:B,triggerReflow:E,generate_csv:C,refresh:F,addIndicator:G,overlay:H,changeTitle:I}});