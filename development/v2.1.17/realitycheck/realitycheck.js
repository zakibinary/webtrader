define(["exports","jquery","../windows/windows","../websockets/binary_websockets","../common/rivetsExtra","lodash","moment","jquery-growl","../common/util"],function(a,b,c,d,e,f,g){"use strict";function h(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0});var i=h(b),j=h(c),k=h(d),l=h(e),m=(h(f),h(g)),n=null,o=null,p=[],q=260,r=310,s={timeOutInMins:(local_storage.get("realitycheck")||{}).timeOutInMins||10,timeOutMin:10,timeOutMax:60,loginId:null,durationInMins:null,bought:null,turnOver:null,loginTime:null,sold:null,pnl:null,currentTime:null,open:null,potentialProfit:null,currency:null,continueTrading:function(a,b){return b.timeOutInMins<b.timeOutMin||b.timeOutInMins>b.timeOutMax?void i["default"].growl.error({message:"Please enter a number between ".i18n()+b.timeOutMin+" and ".i18n()+b.timeOutMax}):(n.dialog("close"),local_storage.set("realitycheck",{timeOutInMins:0|b.timeOutInMins,accepted_time:m["default"].utc().valueOf()}),void u(b.timeOutInMins))},openStatement:function(){require(["statement/statement"],function(a){var b=i["default"]("#nav-menu").find("a.statement");a.init(b),b.click()})},logout:function(){return k["default"].invalidate()}},t=function(a){if(n){var b=n.dialog("widget");a?(n.dialog({height:q}),b.find(".realitycheck_firstscreen").show(),b.find(".realitycheck_secondscreen").hide()):(n.dialog({height:r}),b.find(".realitycheck_firstscreen").hide(),b.find(".realitycheck_secondscreen").show())}},u=function(a){o&&clearTimeout(o);var b=60*a*1e3;o=setTimeout(function(){k["default"].send({reality_check:1}).then(function(a){if(!local_storage.get("authorize").is_virtual){var b=m["default"].utc().valueOf()-1e3*a.reality_check.start_time,c=1728e5;b>c&&(b=c);var d=currencyFractionalDigits();s.durationInMins=m["default"].duration(b).humanize(),s.bought=a.reality_check.buy_count,s.turnOver=a.reality_check.buy_amount,s.loginTime=m["default"].utc(1e3*a.reality_check.start_time).format("MMM D, YYYY hh:mm")+" GMT",s.sold=a.reality_check.sell_count,s.pnl=(a.reality_check.sell_amount-a.reality_check.buy_amount).toFixed(d),s.currentTime=m["default"].utc().format("MMM D, YYYY hh:mm")+" GMT",s.open=a.reality_check.open_contract_count,s.potentialProfit=a.reality_check.potential_profit,s.currency=a.reality_check.currency,t(!1),n.moveToTop()}})},b)},v=function(){return n?Promise.resolve(!0):new Promise(function(a){k["default"].cached.authorize().then(function(b){s.loginId=b.authorize.loginid,k["default"].cached.send({landing_company_details:b.authorize.landing_company_name}).then(function(b){b&&b.landing_company_details.has_reality_check?require(["text!realitycheck/realitycheck.html","css!realitycheck/realitycheck.css"],function(b){var c=i["default"](b).i18n();n=j["default"].createBlankWindow(i["default"]("<div/>"),{title:"Reality check".i18n(),width:600,minHeight:q,height:q,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,closable:!1,modal:!0,closeOnEscape:!1,ignoreTileAction:!0,"data-authorized":"true"}),c.appendTo(n),i["default"]("body").append(n.dialog("widget")),t(!0),l["default"].bind(c[0],s),a()}):local_storage.remove("realitycheck")})})["catch"](function(){return local_storage.remove("realitycheck")})})},w=function(){n&&n.dialog("close"),o&&clearTimeout(o),o=null,s.timeOutInMins=10,s.loginId=null,s.durationInMins=null,s.bought=null,s.turnOver=null,s.loginTime=null,s.sold=null,s.pnl=null,s.currentTime=null,s.open=null,s.potentialProfit=null,s.currency=null},x=function(){if(w(),!local_storage.get("authorize").is_virtual){var a=v();p.push(a),Promise.all(p).then(function(){t(!0),setTimeout(function(){return n.dialog("open")},1e3),p=[]})}};k["default"].events.on("oauth-login",x),k["default"].events.on("login",function(a){s.loginId!=a.authorize.loginid&&w();var b=local_storage.get("realitycheck");if(b&&!local_storage.get("authorize").is_virtual){var c=(m["default"].utc().valueOf()-b.accepted_time)/60/1e3;setTimeout(function(){return v().then(function(){var a=c>=b.timeOutInMins?0:Math.abs(b.timeOutInMins-c);u(a)})},1e3)}else x()}),k["default"].events.on("reset_realitycheck",function(){w(),local_storage.remove("realitycheck")}),k["default"].events.on("switch_account",function(){local_storage.remove("realitycheck"),x()}),a["default"]={}});