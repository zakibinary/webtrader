{"version":3,"sources":["../../../../src/cashier/deposit.es6"],"names":["init","require","deposit_win","deposit_win_view","error_handler","err","console","error","growl","message","li","click","cached","authorize","then","data","currency","local_storage","get","check_currency","init_deposit_win","catch","moveToTop","root","i18n","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","height","close","trigger","remove","open","destroy","unbind","init_state","dialog","offset","top","my","left","at","css","track","module_id","is_unique","app_id","state","route","value","empty_fields","validate","clear","debounce","show","user","email","cashier_url","residence","residence_name","is_cryptocurrency","isCryptoCurrency","standard_methods","iframe_visible","payment_agents","list","current","update","iframe_loaded","get_commission_text","agent","deposit_commission","withdrawal_commission","onclick","e","elem","target","next","cur_elem","is_active","scrollHeight","bind","send","cashier","provider","code","init_win","error_text","residence_promise","get_settings","country_code","country","isChampionFx","paymentagent_list","map","commission_text","supported_banks","toLowerCase","split"],"mappings":"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","file":"deposit.js","sourcesContent":["/*\n * Created by amin on June 26, 2016.\n */\n\nimport $ from 'jquery';\nimport liveapi from 'websockets/binary_websockets';\nimport windows from 'windows/windows';\nimport currencyDialog from 'cashier/currency';\nimport rv from 'common/rivetsExtra';\nimport _ from 'lodash';\nimport moment from 'moment';\nimport tncApprovalWin from \"cashier/uk_funds_protection\"\nimport html from 'text!cashier/deposit.html';\n\nrequire(['text!cashier/deposit.html']);\nrequire(['css!cashier/deposit.css']);\nlet deposit_win = null;\nlet deposit_win_view = null; // rivets view\n\nconst error_handler = function(err) {\n    console.error(err);\n    $.growl.error({ message: err.message });\n};\n\nexport function init(li) {\n    li.click(() => {\n        if (!deposit_win) {\n            liveapi.cached.authorize().then(data => {\n                if (!data.authorize.currency && !local_storage.get(\"currency\")) // if currency is not set ask for currency\n                    return currencyDialog.check_currency();\n                return true; // OK\n            }).then(() => {\n                init_deposit_win(html);\n            }).catch(error_handler);\n        } else\n            deposit_win.moveToTop();\n    });\n}\n\nfunction init_deposit_win(root) {\n    root = $(root).i18n();\n    deposit_win = windows.createBlankWindow(root, {\n        title: 'Deposit funds',\n        resizable: true,\n        collapsable: false,\n        minimizable: true,\n        maximizable: true,\n        width: 700,\n        height: 600,\n        'data-authorized': true,\n        close: function() {\n            deposit_win.trigger('dialogclose'); // TODO: figure out why event is not fired.\n            deposit_win.remove();\n            deposit_win = null;\n        },\n        open: function() {},\n        destroy: function() {\n            deposit_win_view && deposit_win_view.unbind();\n            deposit_win_view = null;\n        }\n    });\n\n    init_state(root);\n    deposit_win.dialog('open');\n\n    /* update dialog position, this way when dialog is resized it will not move*/\n    var offset = deposit_win.dialog('widget').offset();\n    offset.top = 110;\n    deposit_win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\n    deposit_win.dialog('widget').css({\n        left: offset.left + 'px',\n        top: offset.top + 'px'\n    });\n    deposit_win.track({\n        module_id: 'deposit',\n        is_unique: true\n    });\n}\n\nfunction init_state(root) {\n    var app_id = liveapi.app_id;\n    var state = {\n        route: { value: 'standard-methods' },\n        empty_fields: {\n            validate: false,\n            clear: _.debounce(function() {\n                state.empty_fields.validate = false;\n            }, 4000),\n            show: function() {\n                state.empty_fields.validate = true;\n                state.empty_fields.clear();\n            }\n        },\n        user: {\n            email: local_storage.get('authorize').email,\n            cashier_url: '',\n            residence: '',\n            residence_name: ''\n        },\n        is_cryptocurrency: isCryptoCurrency(),\n        standard_methods: {\n            iframe_visible: false,\n        },\n        payment_agents: {\n            list: [],\n            current: {}\n        }\n    };\n\n    state.route.update = route => { state.route.value = route; };\n\n    state.standard_methods.iframe_loaded = function() {\n        if (state.user.cashier_url)\n            state.standard_methods.iframe_visible = true;\n    }\n\n    state.payment_agents.get_commission_text = function(agent) {\n        if (agent.deposit_commission === agent.withdrawal_commission) {\n            return agent.deposit_commission + '% ' + 'commission'.i18n();\n        }\n        return agent.deposit_commission + '% ' + 'deposits'.i18n() + ' / ' +\n            agent.withdrawal_commission + '% ' + 'withdrawals'.i18n();\n    }\n    state.payment_agents.onclick = function(agent, e) {\n        var elem = $(e.target).next();\n        var cur_elem = state.payment_agents.elem;\n        cur_elem && cur_elem.css('max-height', '0');\n        state.payment_agents.current.is_active = false;\n        if (state.payment_agents.current === agent) {\n            state.payment_agents.current = {};\n        } else {\n            state.payment_agents.current = agent;\n            state.payment_agents.elem = elem;\n            elem.css('max-height', elem[0].scrollHeight + 'px');\n            agent.is_active = true;\n        }\n    }\n\n    deposit_win_view = rv.bind(root[0], state);\n\n    /* get the cashier_url */\n    liveapi.send({\n        cashier: 'deposit',\n        provider: 'epg'\n    }).then(function(data) {\n        state.user.cashier_url = data.cashier;\n    }).catch((err) => {\n        if (err.code === \"ASK_UK_FUNDS_PROTECTION\") {\n            deposit_win.dialog(\"close\");\n            tncApprovalWin.init_win().then(() => {\n                init_deposit_win(html);\n            }).catch(err => {\n                error_handler(err);\n            });\n            return;\n        }\n        state.error_text = err.message;\n    });\n\n    /* get the residence field and its states */\n    var residence_promise = liveapi.send({ get_settings: 1 })\n        .then(function(data) {\n            state.user.residence = data.get_settings.country_code;\n            state.user.residence_name = data.get_settings.country;\n        })\n        .catch(error_handler);\n\n\n    /* get payment agents list */\n    residence_promise.then(function() {\n        /*if champion-fx then don't get payment agent*/\n        if (!state.user.residence || isChampionFx())\n            return { paymentagent_list: { list: [] } };\n        return liveapi.send({ paymentagent_list: state.user.residence });\n    }).then(function(data) {\n        var list = data.paymentagent_list.list.map(function(agent) {\n            agent.commission_text = state.payment_agents.get_commission_text(agent);\n            agent.supported_banks = agent.supported_banks.toLowerCase().split(',');\n            return agent;\n        })\n        state.payment_agents.list = list;\n    }).catch(error_handler);\n}\n\nexport default {\n    init: init\n}\n"]}