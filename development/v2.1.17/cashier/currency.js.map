{"version":3,"sources":["../../../../src/cashier/currency.es6"],"names":["require","check_promise","check_currency_async","Promise","resolve","reject","$html","win","createBlankWindow","dialogClass","width","height","resizable","collapsable","minimizable","maximizable","modal","ignoreTileAction","close","dialog","remove","destroy","win_view","unbind","state","disabled","value","array","continue","send","set_account_currency","then","oauth","local_storage","get","currency","set","cached","authorize","cancel","message","i18n","payout_currencies","data","forEach","config","currency_obj","type","push","categories","uniqBy","map","e","catch","formatters","format_category","category","capitalize","bind","check_currency","up"],"mappings":"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","file":"currency.js","sourcesContent":["import $ from 'jquery';\nimport liveapi from 'websockets/binary_websockets';\nimport windows from 'windows/windows';\nimport rv from 'common/rivetsExtra';\nimport html from 'text!cashier/currency.html';\nimport _ from 'lodash';\n\nrequire(['common/util']);\n\nlet check_promise = null;\nconst check_currency_async = () => new Promise((resolve, reject) => {\n  var $html = $(html);\n  var win = windows.createBlankWindow($html, {\n    dialogClass: \"dialog-confirm\",\n    width: 500,\n    height: 210,\n    resizable: false,\n    collapsable: false,\n    minimizable: false,\n    maximizable: false,\n    modal: true,\n    ignoreTileAction: true,\n    close: () => {\n      win.dialog('destroy');\n      win.remove();\n      win = null;\n    },\n    destroy: () => {\n      win_view && win_view.unbind();\n      win_view = null;\n    }\n  });\n\n  var state = {\n    disabled: true,\n    value: 'Select a value',\n    array: ['Select a value'],\n    continue: () => {\n      state.disabled = true;\n      liveapi.send({ set_account_currency: state.value })\n        .then(resolve, reject)\n        .then(() => {\n          // This doesn't work because on emitting the login event currency is reset.\n          // local_storage.set(\"currency\", state.value);\n          const oauth = local_storage.get('oauth');\n          oauth[0].currency = state.value;\n          local_storage.set(\"oauth\", oauth);\n          //Re-authorize\n          liveapi.cached.authorize(true)\n          win.dialog('close');\n        });\n    },\n    cancel: () => {\n      win.dialog('close');\n      reject({ message: 'Please set currency.'.i18n() });\n    }\n  };\n\n  liveapi.cached.send({ payout_currencies: 1 }).then((data) => {\n    state.disabled = false;\n    state.array = [];\n    data.payout_currencies.forEach((currency) => {\n      const config = local_storage.get(\"currencies_config\") || {};\n      const currency_obj = {\n        value: currency,\n        type: config[currency] ? config[currency].type : ''\n      };\n      state.array.push(currency_obj);\n    });\n    state.categories = _.uniqBy(state.array, \"type\").map((e) => e.type);\n    state.value = data.payout_currencies[0];\n  }).catch(() => reject({ message: 'Please try again after few minutes.'.i18n() }));\n\n  rv.formatters.format_category = (category) => {\n    return _.capitalize(category) + \" Currencies\"\n  };\n\n  var win_view = rv.bind($html[0], state);\n  win.dialog('open');\n});\n\nexport const check_currency = () => {\n  if (check_promise) { return check_promise; }\n  check_promise = check_currency_async().then(() => check_promise = null).catch(up => {\n    check_promise = null;\n    throw up;\n  });\n  return check_promise;\n}\n\nexport default {\n  check_currency\n}\n"]}